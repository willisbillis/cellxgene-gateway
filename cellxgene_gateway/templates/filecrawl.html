<!--
 Copyright 2019 Novartis Institutes for BioMedical Research Inc. Licensed
 under the Apache License, Version 2.0 (the "License"); you may not use
 this file except in compliance with the License. You may obtain a copy
 of the License at http://www.apache.org/licenses/LICENSE-2.0. Unless
 required by applicable law or agreed to in writing, software distributed
 under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES
 OR CONDITIONS OF ANY KIND, either express or implied. See the License for
 the specific language governing permissions and limitations under the License.
-->


<html>
<head>
     <title>Cellxgene Gateway - Data Browser</title>
     <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
     <link rel="icon" type="image/png" href="{{ url_for('static', filename='nibr.ico') }}">
     {% for script in extra_scripts %}
     <script src="{{ script }}"></script>
     {% endfor %}
     <script src="{{ url_for('static', filename='js/annotation.js') }}"></script>
     <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
     <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
     <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
     <style>
          body { background: #f8f9fa; }
          .sidebar { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 24px; }
          .dataset-card { border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 24px; }
          .scroll-area { max-height: 70vh; overflow-y: auto; }
          .annotation-item {
               margin-right: 8px;
               white-space: nowrap;
          }
          .download-link {
               color: #007bff;
               text-decoration: none;
               margin-left: 4px;
               font-size: 0.9em;
               padding: 2px 4px;
               border-radius: 3px;
               background: #f8f9fa;
               border: 1px solid #dee2e6;
               display: inline-block;
               line-height: 1;
          }
          .download-link:hover {
               color: #0056b3;
               background: #e9ecef;
               text-decoration: none;
          }
          .annotation-indicator {
               color: #28a745; 
               font-size: 0.8em; 
               font-weight: 500;
               margin-left: 8px;
          }
          .btn-group .btn {
               margin-right: 5px;
          }
     </style>
</head>
<body>
     <div class="container-fluid py-4">
          <div class="row">
               <!-- Sidebar for filters -->
               <div class="col-md-3 sidebar">
                    <h5 class="mb-3">Filter Datasets</h5>
                    <form id="filter-form">
                         <div class="mb-4">
                              <label><strong>Modality</strong></label>
                              {% for modality in modalities %}
                              <div class="form-check">
                                   <input class="form-check-input" type="checkbox" name="modality" value="{{ modality }}" id="modality-{{ modality }}">
                                   <label class="form-check-label" for="modality-{{ modality }}">{{ modality }}</label>
                              </div>
                              {% endfor %}
                         </div>
                         <div class="mb-4">
                              <label><strong>Principal Investigator</strong></label>
                              <select class="form-control" name="pi">
                                   <option value="">Any</option>
                                   {% for pi in principal_investigators %}
                                   <option value="{{ pi }}">{{ pi }}</option>
                                   {% endfor %}
                              </select>
                         </div>
                         <div class="mb-4">
                              <label><strong>Lead</strong></label>
                              <select class="form-control" name="lead">
                                   <option value="">Any</option>
                                   {% for lead in leads %}
                                   <option value="{{ lead }}">{{ lead }}</option>
                                   {% endfor %}
                              </select>
                         </div>
                         <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
                    </form>
               </div>
               <!-- Main area for datasets -->
               <div class="col-md-9">
                    <h2 class="mb-4">Browse Datasets</h2>
                    <div class="scroll-area">
                         {% for dataset in datasets %}
                         <div class="card dataset-card">
                              <div class="card-body">
                                   <div class="row">
                                        <div class="col-md-8">
                                             <h5 class="card-title">{{ dataset.name }}
                                                  {% if dataset.has_annotations %}
                                                  {% set count = dataset.annotations|length %}
                                                  <span class="annotation-indicator">[{{ count }} annotation{% if count > 1 %}s{% endif %} available]</span>
                                                  {% endif %}
                                             </h5>
                                             <p class="card-text mb-1"><strong>Modality:</strong> {{ dataset.modality }}</p>
                                             <p class="card-text mb-1"><strong>Principal Investigator:</strong> {{ dataset.principal_investigator }}</p>
                                             <p class="card-text mb-1"><strong>Lead:</strong> {{ dataset.lead }}</p>
                                             <p class="card-text"><strong>Description:</strong> {{ dataset.description }}</p>
                                        </div>
                                        <div class="col-md-4 text-right align-self-center">
                                             {% if dataset.file_path %}
                                             <div class="btn-group-vertical" style="width: 100%;">
                                                  <a href="/view/{{ dataset.file_path }}/" class="btn btn-success btn-lg">View in Cellxgene</a>
                                                  {% if enable_annotations %}
                                                  {% if dataset.annotations %}
                                                  <div class="btn-group" style="margin-top: 10px;">
                                                       <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                            Launch with Annotations
                                                       </button>
                                                       <div class="dropdown-menu">
                                                            {% for annotation in dataset.annotations %}
                                                            <a class="dropdown-item" href="/view/{{ dataset.file_path.replace('.h5ad', '_annotations') }}/{{ annotation.file }}/">{{ annotation.name }}</a>
                                                            {% endfor %}
                                                            <div class="dropdown-divider"></div>
                                                            <a class="dropdown-item create-new-annotation" href="#" data-dataset-file="{{ dataset.file_path }}">+ Create New Annotation</a>
                                                       </div>
                                                  </div>
                                                  <div class="btn-group" style="margin-top: 5px;">
                                                       <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                            Download Annotations
                                                       </button>
                                                       <div class="dropdown-menu">
                                                            {% for annotation in dataset.annotations %}
                                                            <a class="dropdown-item" href="/download/csv/annotation/{{ dataset.file_path }}/{{ annotation.file }}" download>â¬‡ {{ annotation.name }}</a>
                                                            {% endfor %}
                                                       </div>
                                                  </div>
                                                  {% else %}
                                                  <div style="margin-top: 10px;">
                                                       <a class="btn btn-outline-info create-new-annotation" href="#" data-dataset-file="{{ dataset.file_path }}">+ Create New Annotation</a>
                                                  </div>
                                                  {% endif %}
                                                  {% endif %}
                                             </div>
                                             {% else %}
                                             <a href="/view/{{ dataset.id }}" class="btn btn-success btn-lg">View in Cellxgene</a>
                                             {% endif %}
                                        </div>
                                   </div>
                              </div>
                         </div>
                         {% endfor %}
                         {% if datasets|length == 0 %}
                         <div class="alert alert-info">No datasets match the selected filters.</div>
                         {% endif %}
                    </div>
               </div>
          </div>
     </div>
     <script>
          // Handle filter form submission
          $('#filter-form').on('submit', function(e) {
               e.preventDefault();
               
               // Get form data
               const formData = new FormData(this);
               const params = new URLSearchParams();
               
               // Add modality selections
               const modalities = formData.getAll('modality');
               modalities.forEach(mod => params.append('modality', mod));
               
               // Add PI selection
               const pi = formData.get('pi');
               if (pi) params.append('pi', pi);
               
               // Add lead selection
               const lead = formData.get('lead');
               if (lead) params.append('lead', lead);
               
               // Reload page with filters
               window.location.href = window.location.pathname + '?' + params.toString();
          });

          // Restore form state from URL parameters
          $(document).ready(function() {
               const urlParams = new URLSearchParams(window.location.search);
               
               // Restore modality checkboxes
               const modalities = urlParams.getAll('modality');
               modalities.forEach(mod => {
                    $('input[name="modality"][value="' + mod + '"]').prop('checked', true);
               });
               
               // Restore PI selection
               const pi = urlParams.get('pi');
               if (pi) {
                    $('select[name="pi"]').val(pi);
               }
               
               // Restore lead selection
               const lead = urlParams.get('lead');
               if (lead) {
                    $('select[name="lead"]').val(lead);
               }

               // Handle new annotation creation
               $('.create-new-annotation').click(function(e) {
                    e.preventDefault();
                    const datasetFile = $(this).data('dataset-file');
                    
                    const annotationName = prompt('Name your annotations collection\nnote: the suffix ".csv" will be appended');
                    if (annotationName !== null && annotationName.length > 0) {
                         if (/^[0-9a-zA-Z_]+$/.test(annotationName)) {
                              window.location.href = '/view/csv/' + datasetFile + '/' + annotationName + '.csv';
                         } else {
                              alert('Error: name must match ^[0-9a-zA-Z_]+$\nthat is, only numbers, letters and underscore are allowed');
                         }
                    }
               });
          });
     </script>
</body>
</html>
